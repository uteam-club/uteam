# Руководство по разработке VISTA UTEAM

## 1. Технический стек и версионирование

### 1.1. Фиксация версий зависимостей
- **Никогда** не используйте `latest` или диапазоны версий (`^`, `~`)
- Фиксируйте **точные** версии всех зависимостей в package.json
- Пример: `"next": "14.1.0"` вместо `"next": "^14.1.0"`

### 1.2. Проверенные стабильные версии
Используйте следующие проверенные стабильные версии ключевых пакетов:

```json
{
  "dependencies": {
    "next": "14.1.0",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "next-intl": "3.4.0",
    "next-auth": "4.24.5",
    "@supabase/supabase-js": "2.39.6",
    "tailwindcss": "3.3.3",
    "typescript": "5.3.3",
    "prisma": "5.10.2",
    "@prisma/client": "5.10.2",
    "postcss": "8.4.35",
    "autoprefixer": "10.4.17",
    "zod": "3.22.4",
    "react-hook-form": "7.50.1",
    "node-telegram-bot-api": "0.64.0",
    "chart.js": "4.4.1",
    "xlsx": "0.18.5"
  },
  "devDependencies": {
    "@types/node": "20.11.16",
    "@types/react": "18.2.55",
    "@types/react-dom": "18.2.19",
    "eslint": "8.56.0",
    "eslint-config-next": "14.1.0",
    "@typescript-eslint/eslint-plugin": "6.21.0",
    "@typescript-eslint/parser": "6.21.0"
  }
}
```

### 1.3. Совместимость библиотек
- Все указанные выше версии проверены на совместимость друг с другом
- Next.js 14.1.0 специально выбран как последняя стабильная версия до Next.js 15
- Next-intl 3.4.0 совместим с App Router в Next.js 14.1.0
- При использовании Supabase рекомендуется версия 2.39.6, которая стабильно работает с Next.js 14.1
- Используйте только TypeScript 5.3.3, так как более новые версии могут вызывать конфликты с некоторыми пакетами

### 1.4. Обновление зависимостей
- Обновление зависимостей должно производиться только после тщательного тестирования на отдельной ветке
- Никогда не обновляйте мажорные версии библиотек в рабочих ветках
- Тщательно изучайте changelog перед обновлением зависимостей

## 2. Архитектура проекта

### 2.1. Структура директорий
```
src/
├── app/           # App Router директории
│   ├── [locale]/  # Локализованные маршруты
│   └── api/       # API эндпоинты
├── components/    # Переиспользуемые React компоненты
├── config/        # Конфигурационные файлы
├── hooks/         # Кастомные React hooks
├── lib/           # Вспомогательные функции
├── messages/      # Локализационные файлы
├── prisma/        # Prisma схема и миграции
└── styles/        # CSS и стили
```

### 2.2. Модульная архитектура
- Каждый функциональный блок (описанный в спецификации) должен быть выделен в отдельный модуль
- Модули должны иметь минимальную связанность между собой
- Интеграция модулей происходит через четко определенные интерфейсы

### 2.3. Особенности архитектуры
- Приложение разработано для единственного клуба (Vista)
- Не используется мультитенантность и переключение между клубами
- Доступ к данным осуществляется без фильтрации по clubId
- Поддерживается работа с командами внутри клуба

## 3. Процесс работы с Git

### 3.1. Ветвление
- **main**: производственная ветка, только стабильный код
- **dev**: ветка разработки для интеграции фич
- **feature/название**: отдельные фичи
- **fix/название**: исправления багов

### 3.2. Правила для коммитов
- Коммиты должны быть атомарными (одно изменение = один коммит)
- Сообщения коммитов на русском языке в формате `тип: что сделано`
- Примеры типов: `фича`, `исправление`, `рефакторинг`, `документация`

### 3.3. Процесс интеграции изменений
1. Создание ветки от `dev` для новой фичи
2. Разработка и тестирование в этой ветке
3. Pull Request в `dev` с детальным описанием изменений
4. После успешного тестирования на `dev`, мерж в `main`

### 3.4. Запрещенные практики
- **НИКОГДА** не коммитьте напрямую в `main` или `dev`
- **НИКОГДА** не делайте force push в общие ветки
- **НИКОГДА** не мержите нестабильный/нерабочий код в `dev`

## 4. Интернационализация (i18n)

### 4.1. Стабильная конфигурация локализации
```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  // Другие настройки...
}

module.exports = nextConfig
```

```javascript
// src/middleware.ts
import createMiddleware from 'next-intl/middleware';
import { locales, defaultLocale } from './i18n';

export default createMiddleware({
  locales,
  defaultLocale,
  localePrefix: 'always'
});

export const config = {
  matcher: ['/((?!api|_next|.*\\..*).*)', '/'],
};
```

```javascript
// src/i18n.ts
import {notFound} from 'next/navigation';

export const locales = ['en', 'ru'] as const;
export const defaultLocale = 'ru';

export type Locale = (typeof locales)[number];
```

### 4.2. Локализационные файлы
- Все строки должны быть вынесены в JSON-файлы локализации
- Используйте вложенную структуру ключей
- Пример: `src/messages/ru.json`, `src/messages/en.json`

### 4.3. Использование локализации в компонентах
```tsx
// Server Component
import { getTranslations } from 'next-intl/server';

export async function ServerComponent() {
  const t = await getTranslations('namespace');
  return <h1>{t('key')}</h1>;
}

// Client Component
'use client';
import { useTranslations } from 'next-intl';

export function ClientComponent() {
  const t = useTranslations('namespace');
  return <h1>{t('key')}</h1>;
}
```

## 5. Деплой и окружения

### 5.1. Настройка Vercel
- **Project Settings > General > Build & Development Settings**:
  - Framework Preset: Next.js
  - Build Command: `prisma generate && next build`
  - Output Directory: `.next`

- **Project Settings > Git**:
  - Production Branch: `main`
  - Development Branches: `dev/*`

### 5.2. Домены и окружения
- **main**: домен (`vista.uteam.club`)
- **dev**: превью-домен для разработки
- Все остальные ветки: автоматически генерируемые превью-URL

### 5.3. Очистка кэша
- В случае стабильных проблем с деплоем, очистите кэш:
  - Vercel Dashboard > Project > Settings > General > Build & Development Settings > "Clear Build Cache"

## 6. Тестирование и качество кода

### 6.1. Локальное тестирование
Перед каждым коммитом выполняйте:
```bash
npm run lint
npm run build
```

### 6.2. Статический анализ
- **ESLint**: проверка качества кода
- **TypeScript**: проверка типов
- Настройки CI должны отклонять PR при ошибках линтера

### 6.3. Документирование кода
- Каждая публичная функция/компонент должны иметь JSDoc комментарии
- Сложная логика должна сопровождаться комментариями
- Создавайте README для сложных модулей

## 7. Безопасность и пользователи

### 7.1. Управление пользователями
- Пользователи принадлежат клубу Vista
- Поддерживаются разные роли пользователей
- Пользователи могут быть организованы в команды

### 7.2. Проверки безопасности
- Валидируйте все входные данные на бэкенде
- Используйте подготовленные запросы (Prisma это делает автоматически)
- Не передавайте чувствительные данные на клиент

## 8. Разработка модулей

### 8.1. Процесс добавления нового модуля
1. Создать новую ветку `feature/module-name`
2. Разработать компоненты, API и базу данных для модуля
3. Написать тесты (минимум unit тесты)
4. Создать Pull Request для ревью

### 8.2. Структура модуля
```
src/
└── modules/
    └── module-name/
        ├── components/    # React компоненты
        ├── api/           # API эндпоинты
        ├── hooks/         # Кастомные хуки
        ├── lib/           # Вспомогательные функции
        └── README.md      # Описание модуля
```

## 9. Устранение проблем

### 9.1. Проблемы с кэшем Vercel
1. Очистить кэш в настройках проекта Vercel
2. Удалить локальные кэши (.next, node_modules)
3. Пересоздать ветку с чистой историей

### 9.2. Проблемы с зависимостями
1. Удалить node_modules и package-lock.json
2. Запустить `npm install` заново
3. Проверить, что все зависимости установлены в правильных версиях

## 10. Структура CSS и верстка

### 10.1. Стандартные отступы и контейнеры

Для обеспечения единообразия всех страниц приложения необходимо следовать следующим правилам:

- **Отступы от края экрана:** все страницы должны использовать класс `page-container` для основного содержимого
- **Стандартный размер контейнера:** максимальная ширина 98% от экрана, с боковыми отступами 0.25rem (px-1)
- **Пример использования:**

```jsx
// Правильно - использование стандартного класса
export default function SomePage() {
  return (
    <div className="page-container py-8">
      {/* Содержимое страницы */}
    </div>
  );
}
```

- **Определение классов контейнеров в globals.css:**

```css
@layer components {
  /* Контейнер с ограничением ширины */
  .container-app {
    @apply max-w-[98%] mx-auto px-1 w-full;
  }
  
  /* Контейнер для всех страниц */
  .page-container {
    @apply max-w-[98%] mx-auto px-1 w-full;
  }
}
```

- **Для компонента Layout.tsx** используется класс `container-app`
- **Для навигационного бара** используется класс `max-w-[98%] mx-auto px-1`

### 10.2. Рекомендуемый подход к верстке

Для десктоп-ориентированных приложений рекомендуется использовать подход с минимальным количеством вложенных DOM-элементов:

- **Используйте CSS Grid** для создания сложных макетов вместо множества вложенных div-контейнеров
- **Избегайте избыточных оберток** — каждый дополнительный уровень DOM замедляет рендеринг
- **Предпочитайте плоскую структуру DOM** с CSS-переменными вместо глубокой вложенности

#### Пример эффективного макета с CSS Grid:

```jsx
// ✅ Эффективный подход с CSS Grid
<div className="grid-layout">
  <div className="card">
    Содержимое
  </div>
</div>
```

```css
/* CSS для эффективного подхода */
.grid-layout {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  max-width: var(--content-max-width);
  margin: 0 auto;
  padding: 0 var(--content-padding);
}
```

### 10.3. Оформление навигационной панели Vista

Для навигационной панели используются следующие стилевые решения:

#### Основная навигация
- **Заглавные буквы:** Пункты меню верхнего уровня (разделы) оформляются ЗАГЛАВНЫМИ буквами
- **Разделители:** Между разделами добавляются вертикальные разделители с помощью `border-r border-[#2c3c42]`
- **Отступы:** Для разделов задаются отступы `px-4` для визуального разделения

```jsx
// Пример оформления пункта навигации
<div className="relative px-4 border-r border-[#2c3c42] last:border-r-0">
  <button 
    className="text-[#e6f0f0] hover:text-[#5acce5] flex items-center 
               transition-colors uppercase tracking-wide text-sm font-medium">
    РАЗДЕЛ
    <svg className="ml-1 h-4 w-4">...</svg>
  </button>
</div>
```

#### Выпадающие меню
- **Полупрозрачность:** Для фона выпадающего меню используется непрозрачность 50% (`bg-[#1a2228]/50`)
- **Размытие:** Применяется эффект размытия `backdrop-blur-md` для создания современного стеклянного эффекта
- **Центрирование:** Меню центрируется относительно кнопки с помощью `left-1/2 -translate-x-1/2`

## 11. Важные замечания

- **НЕ используйте** экспериментальные функции, если только они не являются критически необходимыми
- **НЕ обновляйте** мажорные версии зависимостей без тщательного тестирования
- **ВСЕГДА** документируйте архитектурные решения и любые отклонения от стандартов
- **ВСЕГДА** проверяйте работоспособность проекта локально перед пушем 