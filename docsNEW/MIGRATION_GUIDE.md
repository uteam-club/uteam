# Руководство по миграции на однопользовательскую версию VISTA UTEAM

Данное руководство описывает процесс перехода с мультитенантной версии UTEAM на упрощенную версию VISTA UTEAM, предназначенную только для клуба Vista.

## Обзор изменений

В результате миграции изменяется архитектура приложения:

1. **Удаление мультитенантности**:
   - Удаление таблицы `Club` и связанных с ней таблиц
   - Удаление полей `clubId` из всех сущностей
   - Удаление логики фильтрации по клубам

2. **Упрощение структуры данных**:
   - Удаление моделей `ClubModule` и `FeatureModule`
   - Упрощение моделей, связанных с настройками клубов
   
3. **Упрощение интерфейса**:
   - Удаление возможности переключения между клубами
   - Фиксированное использование темы Vista

## Пошаговый план миграции

### 1. Подготовка

Перед началом миграции необходимо:

1. **Создать резервную копию**:
   ```bash
   # Резервное копирование базы данных
   pg_dump -U username -d database -f backup.sql
   
   # Резервное копирование кода
   git clone https://github.com/uteam-club/UTEAM.git UTEAM-backup
   ```

2. **Создать новый репозиторий (опционально)**:
   ```bash
   mkdir VISTA-UTEAM
   cd VISTA-UTEAM
   git init
   ```

3. **Подготовить окружение**:
   ```bash
   # Скопировать основные файлы из текущего проекта
   cp -r ../UTEAM/src ./src
   cp -r ../UTEAM/public ./public
   cp ../UTEAM/package.json ./
   cp ../UTEAM/tsconfig.json ./
   cp ../UTEAM/next.config.js ./
   cp ../UTEAM/.env.example ./
   ```

### 2. Обновление схемы Prisma

1. **Изменение базовой схемы**:

   Создайте новую схему Prisma, основанную на существующей, но без мультитенантности:

   ```prisma
   // prisma/schema.prisma

   generator client {
     provider = "prisma-client-js"
   }

   datasource db {
     provider = "postgresql"
     url      = env("DATABASE_URL")
     directUrl = env("DIRECT_URL")
   }

   // ... остальные модели из PRISMA_SCHEMA.md
   ```

2. **Создание миграции**:

   ```bash
   npx prisma migrate dev --name remove-multitenancy
   ```

   При запросе на подтверждение потери данных, выберите "No" и используйте следующий подход для сохранения данных.

3. **Сохранение данных из существующих таблиц**:

   Создайте SQL-скрипт для переноса данных из старых таблиц в новые:

   ```sql
   -- Пример сохранения данных пользователей клуба Vista
   -- Предполагается, что clubId для Vista известен (например, 'vista-club-id')
   INSERT INTO new_users (id, email, name, image, password, role, createdAt, updatedAt)
   SELECT id, email, name, image, password, role, createdAt, updatedAt 
   FROM users
   WHERE "clubId" = 'vista-club-id';
   
   -- Аналогично для других таблиц...
   ```

### 3. Обновление кода

#### 3.1. Обновление middleware

1. **Упрощение middleware** (`src/middleware.ts`):

   ```typescript
   import createMiddleware from 'next-intl/middleware';
   import { locales, defaultLocale } from './i18n';

   export default createMiddleware({
     locales,
     defaultLocale,
     localePrefix: 'always'
   });

   export const config = {
     matcher: ['/((?!api|_next|.*\\..*).*)', '/'],
   };
   ```

#### 3.2. Обновление API-маршрутов

1. **Удаление фильтрации по clubId**:

   Найдите все API-маршруты и удалите логику определения и фильтрации по `clubId`. Например:

   ```typescript
   // Было:
   const users = await prisma.user.findMany({
     where: { clubId }
   });

   // Стало:
   const users = await prisma.user.findMany();
   ```

2. **Обновление запросов на создание**:

   ```typescript
   // Было:
   const newUser = await prisma.user.create({
     data: {
       ...userData,
       club: { connect: { id: clubId } }
     }
   });

   // Стало:
   const newUser = await prisma.user.create({
     data: userData
   });
   ```

#### 3.3. Обновление компонентов

1. **Удаление контекстов, связанных с клубами**:

   Удалите контексты и провайдеры, связанные с выбором и управлением клубами.

2. **Упрощение навигации**:

   Удалите компоненты выбора клуба из навигации и других UI-элементов.

3. **Фиксированное использование темы Vista**:

   Если использовались другие темы, удалите их и оставьте только тему Vista.

#### 3.4. Обновление аутентификации и авторизации

1. **Упрощение логики авторизации**:

   Удалите проверки прав доступа, связанные с клубами, оставив только проверки ролей пользователей.

### 4. Тестирование

1. **Локальное тестирование**:
   ```bash
   npm run dev
   ```

2. **Проверка основных функций**:
   - Аутентификация
   - Доступ к данным
   - Управление командами
   - Другие базовые функции

### 5. Развертывание

1. **Настройка нового проекта на Vercel**:
   
   Создайте новый проект на Vercel или обновите существующий:
   
   ```bash
   # Если используете Vercel CLI
   vercel
   ```

2. **Настройка поддомена**:
   
   Настройте домен `vista.uteam.club` для нового проекта.

3. **Перенос переменных окружения**:
   
   Перенесите все необходимые переменные окружения в новый проект.

## Возможные проблемы и решения

### 1. Потеря данных при миграции

**Проблема**: При удалении полей и таблиц, связанных с мультитенантностью, существует риск потери данных.

**Решение**: 
- Создайте резервные копии всех данных перед миграцией
- Используйте SQL-скрипты для сохранения данных клуба Vista перед применением миграций
- Проверяйте корректность данных после каждого шага миграции

### 2. Проблемы с авторизацией

**Проблема**: После удаления логики клубов пользователи могут потерять доступ к системе.

**Решение**:
- Обновите логику аутентификации, чтобы она не зависела от clubId
- Создайте временный механизм миграции сессий пользователей
- Предусмотрите возможность сброса пароля для всех пользователей

### 3. Несовместимость интерфейса

**Проблема**: Компоненты, разработанные для мультитенантной версии, могут не работать в упрощенной.

**Решение**:
- Проверьте все компоненты, особенно те, что взаимодействуют с данными клубов
- Обновите компоненты формирования запросов к API
- Тщательно тестируйте интерфейс после каждого обновления

## Чеклист миграции

- [ ] Создана резервная копия данных и кода
- [ ] Обновлена схема Prisma без мультитенантности
- [ ] Данные клуба Vista сохранены в новой структуре
- [ ] Обновлен middleware без определения клуба
- [ ] Обновлены API-маршруты без фильтрации по clubId
- [ ] Обновлены UI-компоненты для работы в однопользовательском режиме
- [ ] Обновлены компоненты аутентификации и авторизации
- [ ] Проведено локальное тестирование
- [ ] Настроен домен vista.uteam.club
- [ ] Приложение успешно развернуто в production 