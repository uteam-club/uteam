# Архитектура приложения UTeam

## Обзор

UTeam - это мультитенантная платформа для управления футбольными клубами. Архитектура приложения основана на современном стеке технологий веб-разработки, включая Next.js, Prisma, PostgreSQL и NextAuth.

## Технологический стек

- **Фронтенд**: Next.js 14.2, React 18, TailwindCSS
- **Бэкенд**: Next.js API Routes (серверные функции)
- **База данных**: PostgreSQL с ORM Prisma
- **Аутентификация**: NextAuth.js, JWT
- **Хранение файлов**: (предполагается использование внешнего хранилища)

## Мультитенантная архитектура

### Основные принципы

Приложение UTeam реализует мультитенантную архитектуру через следующие ключевые компоненты:

1. **Идентификация тенанта**: Каждый футбольный клуб представлен отдельным тенантом и идентифицируется через уникальный поддомен (например, `club1.uteam.app`).

2. **Маршрутизация**: Middleware анализирует поддомены и направляет пользователей на соответствующие страницы клубов.

3. **Изоляция данных**: Каждая сущность в базе данных связана с конкретным клубом через поле `clubId`.

4. **Контекст клуба**: React Context обеспечивает доступ к данным клуба во всех компонентах приложения.

### Схема базы данных

В центре модели данных находится сущность `Club`. Все остальные сущности имеют связь с клубом:

```
Club (id, name, subdomain, ...)
  ↓
  ├── User (id, email, clubId, role, ...)
  ├── Team (id, name, clubId, ...)
  ├── Event (id, title, clubId, ...)
  └── MediaItem (id, url, clubId, ...)
```

### Аутентификация и авторизация

- Аутентификация осуществляется через NextAuth.js
- В токене и сессии хранится `clubId` пользователя
- При входе через поддомен проверяется принадлежность пользователя к соответствующему клубу
- Права доступа определяются ролью пользователя (`SUPER_ADMIN`, `ADMIN`, `COACH`, `MEMBER`)

### Маршрутизация и поддомены

Для обработки запросов на различных поддоменах используется middleware:

1. При запросе к поддомену (например, `club1.uteam.app`) middleware определяет соответствующий клуб.
2. Если пользователь аутентифицирован и принадлежит к этому клубу, он получает доступ к данным.
3. Для основного домена (`uteam.app`) отображается главная страница или административная панель для супер-администраторов.

## Структура каталогов

```
/src
  /app               # Страницы приложения (Next.js App Router)
  /components        # React-компоненты
  /context           # React контекст, включая ClubContext
  /lib               # Утилиты и общие функции
  /providers         # React провайдеры (Auth, Club)
  /services          # Сервисные функции для работы с данными
  /types             # TypeScript типы
  /generated         # Сгенерированный код (Prisma Client)

/prisma
  schema.prisma      # Схема данных Prisma
  /migrations        # Миграции базы данных

/public              # Статические файлы
```

## Ключевые компоненты мультитенантности

### 1. ClubContext и ClubProvider

`ClubContext` хранит данные о текущем клубе и делает их доступными во всех компонентах.
`ClubProvider` загружает данные о клубе при аутентификации пользователя.

### 2. Middleware

Middleware перехватывает все запросы и на основе поддомена определяет текущий клуб.

### 3. API-маршруты

Все API-запросы фильтруют данные по `clubId` для обеспечения изоляции между тенантами.

## Диаграмма архитектуры

```
┌─────────────────┐       ┌─────────────────┐
│  tenant1.app    │       │  tenant2.app    │
└────────┬────────┘       └────────┬────────┘
         │                         │
         ▼                         ▼
┌─────────────────────────────────────────────┐
│              Middleware                      │
│  (определение тенанта по поддомену)         │
└────────────────────┬────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────┐
│              NextAuth                        │
│  (аутентификация и авторизация)             │
└────────────────────┬────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────┐
│              ClubProvider                    │
│  (контекст данных клуба)                    │
└────────────────────┬────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────┐
│              Prisma ORM                      │
│  (фильтрация данных по clubId)              │
└────────────────────┬────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────┐
│           PostgreSQL Database                │
│                                             │
└─────────────────────────────────────────────┘
``` 