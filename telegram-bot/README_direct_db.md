# Telegram Bot с прямым доступом к базе данных

## Обзор

Эта версия Telegram-бота реализует прямой доступ к PostgreSQL базе данных для автоматической рассылки утренних опросов игрокам. Бот обходит проблемы с авторизацией API и работает напрямую с базой данных.

## Преимущества

- **Надежность**: Прямой доступ к базе данных без зависимости от API
- **Производительность**: Отсутствие накладных расходов на HTTP-запросы
- **Простота**: Один бот работает со всеми клубами и командами
- **Безопасность**: Отдельный пользователь БД с правами только на чтение

## Установка

### 1. Подготовка базы данных

Сначала необходимо создать пользователя базы данных с правами только на чтение:

```bash
# Подключитесь к базе данных как суперпользователь
psql -h rc1d-40uv9fbi8p02b5c0.mdb.yandexcloud.net -p 6432 -U postgres -d uteam

# Выполните SQL-скрипт
\i scripts/create-bot-db-user.sql
```

### 2. Установка зависимостей

```bash
cd telegram-bot
pip install -r requirements_direct_db.txt
```

### 3. Настройка переменных окружения

Создайте файл `.env` в папке `telegram-bot`:

```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
```

### 4. SSL сертификат

Убедитесь, что файл `yandex_root.crt` находится в папке `telegram-bot`.

## Тестирование

Перед запуском бота протестируйте подключение к базе данных:

```bash
python test_db_connection.py
```

Скрипт проверит:
- Подключение к базе данных
- Права доступа (только чтение)
- Доступность необходимых таблиц
- Корректность запросов

## Запуск

```bash
python bot_direct_db.py
```

## Архитектура

### Подключение к базе данных

```python
DB_CONFIG = {
    'host': 'rc1d-40uv9fbi8p02b5c0.mdb.yandexcloud.net',
    'port': 6432,
    'database': 'uteam',
    'user': 'uteam_bot_reader',
    'password': 'uteambot567234!',
    'sslmode': 'verify-full',
    'sslcert': './yandex_root.crt'
}
```

### Основные функции

1. **`get_survey_schedules()`** - Получает все активные расписания рассылок
2. **`get_team_players(team_id)`** - Получает игроков команды с telegramId
3. **`bind_telegram_to_player(pin_code, telegram_id, language)`** - Привязывает Telegram ID к игроку
4. **`send_survey_broadcast()`** - Основная функция рассылки (запускается каждую минуту)

### Планировщик

Бот использует APScheduler для проверки расписаний каждую минуту:

```python
scheduler = AsyncIOScheduler()
scheduler.add_job(send_survey_broadcast, 'interval', minutes=1)
```

### HTTP API

Бот также предоставляет HTTP endpoints для ручной отправки:

- `POST /send-morning-survey` - Отправка утреннего опроса
- `POST /send-survey-success` - Отправка сообщения об успешном прохождении

## Безопасность

### Права пользователя базы данных

Пользователь `uteam_bot_reader` имеет только права на:
- `CONNECT` к базе данных `uteam`
- `USAGE` схемы `public`
- `SELECT` на все таблицы
- `USAGE` на последовательности (для UUID)

### Ограничения

- Нет прав на `INSERT`, `UPDATE`, `DELETE`
- Нет прав на создание/изменение схемы
- Нет прав на создание/удаление таблиц

## Мониторинг

Бот выводит подробные логи:

```
[BOT] Запуск Telegram-бота с прямым доступом к базе данных...
[Scheduler] Планировщик запущен
HTTP server started on port 8080
[Scheduler] Проверка расписаний рассылок...
[Scheduler] Найдено 3 активных расписаний
[DEBUG] Проверка: sendTime=08:00, now_str=08:00, timezone=Europe/Moscow
[DEBUG] Получено игроков для рассылки: 15
[DEBUG] Сообщение отправлено: telegramId=123456789
```

## Устранение неполадок

### Ошибки подключения к базе данных

1. Проверьте SSL сертификат: `yandex_root.crt`
2. Убедитесь, что пользователь создан: `\du uteam_bot_reader`
3. Проверьте права: `\dp "SurveySchedule"`

### Ошибки отправки сообщений

1. Проверьте токен бота в `.env`
2. Убедитесь, что игроки имеют `telegramId`
3. Проверьте, что команды имеют `timezone`

### Тестирование

```bash
# Тест подключения
python test_db_connection.py

# Тест отправки сообщения
curl -X POST http://localhost:8080/send-morning-survey \
  -H "Content-Type: application/json" \
  -d '{"telegramId":"123456789","clubId":"club-uuid","pinCode":"123456"}'
```

## Миграция с API версии

1. Остановите старый бот
2. Создайте пользователя БД
3. Установите новые зависимости
4. Запустите новый бот
5. Протестируйте подключение

## Поддержка

При возникновении проблем:

1. Проверьте логи бота
2. Запустите тест подключения
3. Проверьте права пользователя БД
4. Убедитесь в корректности данных в таблицах 