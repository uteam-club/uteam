#!/bin/bash

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
echo "=========================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ –±–æ—Ç
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞..."
if pgrep -f "bot_direct_db.py" > /dev/null; then
    echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    pkill -f "bot_direct_db.py"
    sleep 2
else
    echo "‚ÑπÔ∏è –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –±–æ—Ç–∞
echo "2Ô∏è‚É£ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –±–æ—Ç–∞..."
cd telegram-bot

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
if [ ! -d "venv" ]; then
    echo "üì¶ –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    python3 -m venv venv
fi

source venv/bin/activate
pip install -r requirements_direct_db.txt > /dev/null 2>&1

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
echo "4Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ..."
nohup python bot_direct_db.py > bot.log 2>&1 &
BOT_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "5Ô∏è‚É£ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ps -p $BOT_PID > /dev/null; then
    echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $BOT_PID)"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"
    echo "üìã –õ–æ–≥–∏ –±–æ—Ç–∞:"
    tail -20 bot.log
    exit 1
fi

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É
cd ..

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
echo "6Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
source venv/bin/activate
python3 test-all-fixes.py

echo ""
echo "üéØ –ì–æ—Ç–æ–≤–æ! –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω"
echo "üìã –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞: kill $BOT_PID"
echo "üìã –õ–æ–≥–∏ –±–æ—Ç–∞: tail -f telegram-bot/bot.log"
