# Улучшения normalizeRowsForMapping

## Обзор

Исправлена функция `normalizeRowsForMapping` для устойчивой работы с тремя основными случаями GPS данных.

## Реализованные улучшения

### 1. Три стратегии нормализации

#### **Случай 1: Объекты с заголовками**
- **Входные данные**: Уже нормализованные объекты
- **Стратегия**: `objects`
- **Обработка**: Возвращает данные как есть

#### **Случай 2: Массивы + headers**
- **Входные данные**: Массивы значений + массив заголовков
- **Стратегия**: `byHeaders`
- **Обработка**: Маппинг по именам заголовков
- **Устойчивость**: Обрабатывает массивы разной длины

#### **Случай 3: Массивы без headers (sourceIndex)**
- **Входные данные**: Массивы значений без заголовков
- **Стратегия**: `bySourceIndex`
- **Обработка**: Использует `sourceIndex` из снапшота профиля
- **Fallback**: Эвристическое определение типов

### 2. Улучшенная эвристика

#### **Определение типов данных:**
- **Имя игрока**: Первая колонка с текстом (содержит буквы)
- **Время**: Формат `HH:MM:SS` или `MM:SS`
- **Дистанция**: Числа 100-50000 (метры)
- **Скорость**: Числа 10-50 (км/ч)
- **Проценты**: Числа 0-100

#### **Анализ по всем строкам:**
- Проверяет все значения в колонке для точного определения типа
- Избегает ложных срабатываний на основе одной строки

### 3. Гарантии устойчивости

#### **normalize.rows > 0:**
- Всегда возвращает строки для валидных данных
- Обрабатывает граничные случаи (null, undefined, пустые массивы)
- Предотвращает ситуации с `canonRows = 0`

#### **Обработка ошибок:**
- Никогда не выбрасывает исключения
- Возвращает предупреждения в `warnings[]`
- Fallback стратегии для неизвестных форматов

## Тестирование

### Unit-тесты
```bash
npm test -- --testPathPatterns="normalizeRowsForMapping.improved.test.ts"
```

### Покрытие тестов:
- ✅ Случай 1: Объекты с заголовками
- ✅ Случай 2: Массивы + headers
- ✅ Случай 3: Массивы без headers (sourceIndex)
- ✅ Случай 4: Эвристика (fallback)
- ✅ Граничные случаи
- ✅ Гарантия normalize.rows > 0

### Фикстуры
- `fixtures/gps/bsight-normalize-test.csv` - B-SIGHT тестовые данные

## Файлы

- `src/services/gps/normalizeRowsForMapping.ts` - основная функция
- `src/services/gps/__tests__/normalizeRowsForMapping.improved.test.ts` - тесты
- `fixtures/gps/bsight-normalize-test.csv` - тестовые данные

## Результат

✅ **Устойчивая работа** с любыми форматами GPS данных  
✅ **Гарантия normalize.rows > 0** для валидных данных  
✅ **Три стратегии нормализации** покрывают все случаи  
✅ **Улучшенная эвристика** для fallback сценариев  
✅ **Полное покрытие тестами** всех сценариев  

Теперь `normalizeRowsForMapping` надёжно обрабатывает все типы GPS данных и предотвращает ситуации с `canonRows = 0`.
